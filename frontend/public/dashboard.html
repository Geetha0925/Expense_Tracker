<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BudgetWise AI ‚Äì Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI", Arial, sans-serif;}
:root{
--card-bg:#ffffff;
--text:#1f2933;
--header:#2c3e50;
--sidebar:#34495e;
--primary:#00c6ff;
--shadow:0 15px 35px rgba(0,0,0,0.18);
}
body.dark{
--card-bg:#13293d;
--text:#eaf1f8;
--header:#0f2a44;
--sidebar:#0d2438;
}
body{
min-height:100vh;
color:var(--text);
background-image:url("https://images.unsplash.com/photo-1554224155-8d04cb21cd6c");
background-size:cover;
background-position:center;
background-attachment:fixed;
}
header{
background:var(--header);
color:white;
padding:18px 30px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:var(--shadow);
}
.header-actions{display:flex;gap:10px;}
.header-actions button{
padding:8px 14px;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:600;
}
.logout-btn{background:#e74c3c;color:white;}
.theme-btn{background:#00c6ff;color:black;}

.container{display:flex;min-height:calc(100vh - 130px);}
.sidebar{
width:260px;
background:var(--sidebar);
padding:25px 15px;
}
.sidebar button{
width:100%;
padding:13px;
margin-bottom:14px;
border:none;
border-radius:12px;
background:rgba(255,255,255,0.12);
color:white;
cursor:pointer;
}
.sidebar button:hover{background:var(--primary);color:black;}

.main{flex:1;padding:35px;}

.summary{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
gap:20px;
margin-bottom:30px;
}
.summary-box{
background:var(--card-bg);
padding:22px;
border-radius:16px;
box-shadow:var(--shadow);
text-align:center;
}
.summary-box h4{margin-bottom:10px;font-size:15px;opacity:0.8;}
.summary-box p{font-size:24px;font-weight:bold;}

.box{
background:var(--card-bg);
border-radius:18px;
padding:28px;
box-shadow:var(--shadow);
margin-bottom:30px;
}

input,select{
width:100%;
padding:11px;
margin-bottom:14px;
border-radius:10px;
border:1px solid #ccc;
}

button{
padding:11px 20px;
border:none;
border-radius:10px;
background:linear-gradient(135deg,#00c6ff,#0072ff);
color:white;
cursor:pointer;
}

table{width:100%;border-collapse:collapse;}
th{background:var(--header);color:white;padding:14px;}
td{padding:12px;text-align:center;border-bottom:1px solid #ddd;}

footer{
background:var(--header);
color:white;
text-align:center;
padding:18px;
}

#incomeBox,#savingsBox,#add,#list,#monthly,#yearly,#aiBox{display:none;}
</style>
</head>

<body>

<header>
<h2>BudgetWise AI ‚Äì Dashboard</h2>
<div class="header-actions">
<button class="theme-btn" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<div class="sidebar">
<button onclick="showSection('incomeBox')">üí∞ Add Income</button>
<button onclick="showSection('savingsBox')">üè¶ Add Savings</button>
<button onclick="showSection('add')">‚ûï Add Expense</button>
<button onclick="showSection('list')">üìã All Expenses</button>
<button onclick="showSection('monthly')">üìä Monthly View</button>
<button onclick="showSection('yearly')">üìà Yearly View</button>
<button onclick="showSection('aiBox')">ü§ñ AI Insights</button>
</div>

<div class="main">

<div class="summary">
<div class="summary-box"><h4>Total Income</h4><p>‚Çπ <span id="totalIncome">0</span></p></div>
<div class="summary-box"><h4>Total Expenses</h4><p>‚Çπ <span id="totalExpense">0</span></p></div>
<div class="summary-box"><h4>Total Savings</h4><p>‚Çπ <span id="totalSavings">0</span></p></div>
<div class="summary-box"><h4>Remaining Balance</h4><p>‚Çπ <span id="remainingBalance">0</span></p></div>
</div>

<div id="list" class="box">
<h3>üìã All Expenses</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Amount</th>
<th>Category</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody id="expenseTable"></tbody>
</table>
</div>

<div id="aiBox" class="box">
<h3>ü§ñ AI Budget Insights</h3>

<div id="aiAdvice" style="margin-bottom:15px;">
Click Generate to get AI insights...
</div>


<button onclick="loadAIAdvice()">Generate AI Insights</button>

<hr style="margin:25px 0;">

</div>
<div id="incomeBox" class="box">
<input id="incomeInput" type="number" placeholder="Enter Income Amount">
<button onclick="setIncome()">Save Income</button>
</div>

<div id="savingsBox" class="box">
<input id="savingsInput" type="number" placeholder="Enter Savings Amount">
<button onclick="setSavings()">Save Savings</button>
</div>

<div id="add" class="box">
<input id="expName" placeholder="Expense Name">
<input id="expAmount" type="number" placeholder="Amount">
<select id="expCategory">
<option value="">Select Category</option>
<option>Food</option>
<option>Rent</option>
<option>Travel</option>
<option>Shopping</option>
<option>Other</option>
</select>
<input id="expDate" type="date">
<button onclick="addExpense()">Save Expense</button>
</div>

<div id="monthly" class="box">
<input type="month" id="monthSelect" onchange="renderMonthlyChart()">
<canvas id="monthlyChart"></canvas>
</div>

<div id="yearly" class="box">
<input type="number" id="yearSelect" placeholder="Enter Year (2026)" onchange="renderYearlyChart()">
<canvas id="yearlyChart"></canvas>
</div>

</div>
</div>

<footer>¬© 2026 BudgetWise AI ‚Äì MongoDB Dashboard</footer>

<script>
const API = "http://localhost:8080/auth";
const email = localStorage.getItem('bw_user_email');

if (localStorage.getItem('bw_logged_in') !== "true" || !email) {
alert("Please login first!");
window.location.href = "login.html";
}

let expenses = [];
let income = Number(localStorage.getItem("bw_income")) || 0;
let savings = Number(localStorage.getItem("bw_savings")) || 0;
let editId = null;
/* ‚úÖ FIX ADDED HERE */
let monthlyChartInstance = null;
let yearlyChartInstance = null;
/* ‚úÖ END FIX */
const MIN_BALANCE = 1000;
const today = new Date().toISOString().split('T')[0];

document.addEventListener('DOMContentLoaded', () => {
document.getElementById('expDate').max = today;
updateSummary();
loadExpenses();
showSection('list');
});

async function loadExpenses() {
try {
const res = await fetch(`${API}/expenses/${email}`);
expenses = await res.json();
renderTable();
updateSummary();
} catch {
alert("Backend not running!");
}
}

function setIncome() {
const val = parseFloat(incomeInput.value);
if (!val || val <= 0) return alert("Enter valid income!");
income = val;
localStorage.setItem("bw_income", income);
updateSummary();
}

function setSavings() {
const val = parseFloat(savingsInput.value);
if (val < 0) return alert("Enter valid savings!");
savings = val;
localStorage.setItem("bw_savings", savings);
updateSummary();
}

async function addExpense() {
const name = expName.value;
const amount = parseFloat(expAmount.value);
const category = expCategory.value;
const date = expDate.value;

if (!name || !amount || !category || !date)
return alert("Fill all fields!");

let totalExpense = expenses.reduce((s,e)=>s+e.amount,0);

if (editId !== null) {
const oldExpense = expenses.find(e => (e._id || e.id) === editId);
if (oldExpense) totalExpense -= oldExpense.amount;
}

const remainingAfterExpense = income - savings - totalExpense - amount;

if (remainingAfterExpense < 0)
return alert("‚ùå Remaining budget cannot be negative!");

if (remainingAfterExpense < MIN_BALANCE)
return alert("‚ö† Minimum balance ‚Çπ1000 required!");

const expenseData = { userEmail: email, name, amount, category, date };

let url = `${API}/expense`;
let method = "POST";

if (editId !== null) {
url = `${API}/expense/${editId}`;
method = "PUT";
}

await fetch(url, {
method,
headers: { "Content-Type": "application/json" },
body: JSON.stringify(expenseData)
});

editId = null;
expName.value = "";
expAmount.value = "";
expCategory.value = "";
expDate.value = "";

loadExpenses();
showSection('list');
}

function editExpense(id) {
const expense = expenses.find(e => (e._id || e.id) === id);
if (!expense) return alert("Expense not found!");

expName.value = expense.name;
expAmount.value = expense.amount;
expCategory.value = expense.category;
expDate.value = expense.date;

editId = id;
showSection('add');
}

async function deleteExpense(id) {
if (!confirm("Are you sure you want to delete this expense?")) return;

try {
await fetch(`${API}/expense/${id}`, { method: "DELETE" });
loadExpenses();
} catch {
alert("Delete failed! Backend not running?");
}
}

function renderTable() {
expenseTable.innerHTML = "";
if (!expenses.length) {
expenseTable.innerHTML = `<tr><td colspan="5">No expenses found.</td></tr>`;
return;
}
expenses.forEach(e => {
const id = e._id || e.id;
expenseTable.innerHTML += `
<tr>
<td>${e.name}</td>
<td>‚Çπ${e.amount}</td>
<td>${e.category}</td>
<td>${e.date}</td>
<td>
<button onclick="editExpense('${id}')">Edit</button>
<button onclick="deleteExpense('${id}')">Delete</button>
</td>
</tr>`;
});
}

function updateSummary() {
const total = expenses.reduce((s,e)=>s+e.amount,0);
totalIncome.textContent = income;
totalSavings.textContent = savings;
totalExpense.textContent = total;
remainingBalance.textContent = income - savings - total;
}

async function loadAIAdvice() {

const adviceBox = document.getElementById("aiAdvice");
adviceBox.innerText = "Generating Enterprise AI Report... ü§ñ";

try {

const res = await fetch(`${API}/ai-advice`, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
email: email,
income: income
})
});

if (!res.ok) {
throw new Error("Server error " + res.status);
}

const advice = await res.text();
adviceBox.innerText = advice;

} catch (error) {
console.error("AI Error:", error);
adviceBox.innerText = "AI server not responding.";
}

}

function showSection(id){
['incomeBox','savingsBox','add','list','monthly','yearly','aiBox']
.forEach(sec=>document.getElementById(sec).style.display="none");
document.getElementById(id).style.display="block";
}

function renderMonthlyChart(){
const selectedMonth = document.getElementById("monthSelect").value;
if(!selectedMonth) return;
const [year, month] = selectedMonth.split("-");
const categoryTotals = {};
expenses.forEach(e=>{
const d = new Date(e.date);
if(d.getFullYear() == year && (d.getMonth()+1) == month){
categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
}
});
if(monthlyChartInstance){ monthlyChartInstance.destroy(); }
monthlyChartInstance = new Chart(document.getElementById("monthlyChart"),{
type:'bar',
data:{
labels:Object.keys(categoryTotals),
datasets:[{label:'Monthly Expenses',data:Object.values(categoryTotals),borderWidth:1}]
},
options:{responsive:true}
});
}

function renderYearlyChart(){
const selectedYear = document.getElementById("yearSelect").value;
if(!selectedYear) return;
const monthlyTotals = Array(12).fill(0);
expenses.forEach(e=>{
const d = new Date(e.date);
if(d.getFullYear() == selectedYear){
monthlyTotals[d.getMonth()] += e.amount;
}
});
if(yearlyChartInstance){ yearlyChartInstance.destroy(); }
yearlyChartInstance = new Chart(document.getElementById("yearlyChart"),{
type:'line',
data:{
labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
datasets:[{label:'Yearly Expenses',data:monthlyTotals,fill:false,tension:0.3}]
},
options:{responsive:true}
});
}


function toggleTheme(){ document.body.classList.toggle('dark'); }
function logout(){ localStorage.clear(); window.location.href="login.html"; }





</script>

</body>
</html>
