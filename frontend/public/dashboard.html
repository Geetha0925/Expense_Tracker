<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BudgetWise AI ‚Äì Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI", Arial, sans-serif;}
:root{
--card-bg:#ffffff;
--text:#1f2933;
--header:#2c3e50;
--sidebar:#34495e;
--primary:#00c6ff;
--shadow:0 15px 35px rgba(0,0,0,0.18);
}
body.dark{
--card-bg:#13293d;
--text:#eaf1f8;
--header:#0f2a44;
--sidebar:#0d2438;
}
body{
min-height:100vh;
color:var(--text);
background-image:url("https://images.unsplash.com/photo-1554224155-8d04cb21cd6c");
background-size:cover;
background-position:center;
background-attachment:fixed;
}

header{
background:var(--header);
color:white;
padding:18px 30px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:var(--shadow);
}

.header-actions{display:flex;gap:10px;}
.header-actions button{
padding:8px 14px;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:600;
}

.logout-btn{background:#e74c3c;color:white;}
.theme-btn{background:#00c6ff;color:black;}

.container{display:flex;min-height:calc(100vh - 130px);}
.sidebar{
width:260px;
background:var(--sidebar);
padding:25px 15px;
}
.sidebar button{
width:100%;
padding:13px;
margin-bottom:14px;
border:none;
border-radius:12px;
background:rgba(255,255,255,0.12);
color:white;
cursor:pointer;
}
.sidebar button:hover{background:var(--primary);color:black;}

.main{flex:1;padding:35px;}

.summary{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
gap:20px;
margin-bottom:30px;
}

.summary-box{
background:var(--card-bg);
padding:22px;
border-radius:16px;
box-shadow:var(--shadow);
text-align:center;
}

.summary-box h4{margin-bottom:10px;font-size:15px;opacity:0.8;}
.summary-box p{font-size:24px;font-weight:bold;}

.box{
background:var(--card-bg);
border-radius:18px;
padding:28px;
box-shadow:var(--shadow);
margin-bottom:30px;
}

input,select{
width:100%;
padding:11px;
margin-bottom:14px;
border-radius:10px;
border:1px solid #ccc;
}

button{
padding:11px 20px;
border:none;
border-radius:10px;
background:linear-gradient(135deg,#00c6ff,#0072ff);
color:white;
cursor:pointer;
}

table{width:100%;border-collapse:collapse;}
th{background:var(--header);color:white;padding:14px;}
td{padding:12px;text-align:center;border-bottom:1px solid #ddd;}

.action-btn{
padding:6px 14px;
border-radius:8px;
color:white;
border:none;
}
.edit{background:#f39c12;}
.delete{background:#e74c3c;}

footer{
background:var(--header);
color:white;
text-align:center;
padding:18px;
}

#incomeBox,#savingsBox,#add,#list,#monthly,#yearly{display:none;}
</style>
</head>

<body>

<header>
<h2>BudgetWise AI ‚Äì Dashboard</h2>
<div class="header-actions">
<button class="theme-btn" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<div class="sidebar">
<button onclick="showSection('incomeBox')">üí∞ Add Income</button>
<button onclick="showSection('savingsBox')">üè¶ Add Savings</button>
<button onclick="showSection('add')">‚ûï Add Expense</button>
<button onclick="showSection('list')">üìã All Expenses</button>
<button onclick="showSection('monthly')">üìä Monthly View</button>
<button onclick="showSection('yearly')">üìà Yearly View</button>
</div>

<div class="main">

<div class="summary">
<div class="summary-box"><h4>Total Income</h4><p>‚Çπ <span id="totalIncome">0</span></p></div>
<div class="summary-box"><h4>Total Expenses</h4><p>‚Çπ <span id="totalExpense">0</span></p></div>
<div class="summary-box"><h4>Total Savings</h4><p>‚Çπ <span id="totalSavings">0</span></p></div>
<div class="summary-box"><h4>Remaining Balance</h4><p>‚Çπ <span id="remainingBalance">0</span></p></div>
</div>



<div id="list" class="box">

<h3>ü§ñ AI Budget Insights</h3>

<div id="aiSection" style="margin-bottom:25px;">
    <div id="aiAdvice">Open All Expenses to generate AI insights...</div>

    <div style="margin-top:15px;">
        <label>AI Budget Score</label>
        <div style="background:#ddd;border-radius:20px;height:25px;">
            <div id="scoreBar"
                 style="height:25px;width:0%;background:green;
                 border-radius:20px;text-align:center;color:white;">
            </div>
        </div>
    </div>
</div>

<hr style="margin:20px 0;">

<h3>üìã All Expenses</h3>

<table>
<thead>
<tr>
<th>Name</th>
<th>Amount</th>
<th>Category</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody id="expenseTable"></tbody>
</table>

</div>




<div id="incomeBox" class="box">
<input id="incomeInput" type="number" placeholder="Enter Income Amount">
<button onclick="setIncome()">Save Income</button>
</div>

<div id="savingsBox" class="box">
<input id="savingsInput" type="number" placeholder="Enter Savings Amount">
<button onclick="setSavings()">Save Savings</button>
</div>

<div id="add" class="box">
<input id="expName" placeholder="Expense Name">
<input id="expAmount" type="number" placeholder="Amount">
<select id="expCategory">
<option value="">Select Category</option>
<option>Food</option>
<option>Rent</option>
<option>Travel</option>
<option>Shopping</option>
<option>Other</option>
</select>
<input id="expDate" type="date">
<button onclick="addExpense()">Save Expense</button>
</div>

<div id="list" class="box">
<table>
<thead>
<tr><th>Name</th><th>Amount</th><th>Category</th><th>Date</th><th>Action</th></tr>
</thead>
<tbody id="expenseTable"></tbody>
</table>
</div>

<div id="monthly" class="box">
<input type="month" id="monthSelect" onchange="renderMonthlyChart()">
<canvas id="monthlyChart"></canvas>
</div>

<div id="yearly" class="box">
<input type="number" id="yearSelect" placeholder="Enter Year (2026)" onchange="renderYearlyChart()">
<canvas id="yearlyChart"></canvas>
</div>

</div>
</div>

<footer>¬© 2026 BudgetWise AI ‚Äì MongoDB Dashboard</footer>

<script>

const API = "http://localhost:8080/auth";
const email = localStorage.getItem('bw_user_email');

if (localStorage.getItem('bw_logged_in') !== "true" || !email) {
    alert("Please login first!");
    window.location.href = "login.html";
}

let expenses = [];
let income = Number(localStorage.getItem("bw_income")) || 0;
let savings = Number(localStorage.getItem("bw_savings")) || 0;
let editId = null;

const MIN_BALANCE = 1000; // üî• Minimum required balance
const today = new Date().toISOString().split('T')[0];

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('expDate').max = today;
    loadExpenses();
    showSection('list');
});

/* ================= LOAD EXPENSES ================= */

async function loadExpenses() {
    try {
        const res = await fetch(`${API}/expenses/${email}`);
        expenses = await res.json();
        renderTable();
        updateSummary();
    } catch {
        alert("Backend not running!");
    }
}

/* ================= ADD / UPDATE EXPENSE ================= */

async function addExpense() {

    const name = document.getElementById("expName").value;
    const amount = parseFloat(document.getElementById("expAmount").value);
    const category = document.getElementById("expCategory").value;
    const date = document.getElementById("expDate").value;

    if (!name || !amount || !category || !date) {
        alert("Please fill all fields!");
        return;
    }

    // üî• Calculate total existing expenses
    let totalExpense = expenses.reduce((s,e)=>s+e.amount,0);

    // üî• If editing, remove old amount before recalculating
    if (editId) {
        const oldExpense = expenses.find(e => (e._id || e.id) === editId);
        if (oldExpense) {
            totalExpense -= oldExpense.amount;
        }
    }

    // üî• Calculate remaining after adding this expense
    const remainingAfterExpense = income - savings - totalExpense - amount;

    // üö® RULE 1: Cannot go negative
    if (remainingAfterExpense < 0) {
        alert("‚ùå Remaining budget cannot be negative!");
        return;
    }

    // üö® RULE 2: Must maintain minimum ‚Çπ1000 balance
    if (remainingAfterExpense < MIN_BALANCE) {
        alert("‚ö† Minimum balance of ‚Çπ1000 must be maintained in account!");
        return;
    }

    const expenseData = {
        userEmail: email,
        name: name,
        amount: amount,
        category: category,
        date: date
    };

    try {

        let url = `${API}/expense`;
        let method = "POST";

        if (editId) {
            url = `${API}/expense/${editId}`;
            method = "PUT";
        }

        const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(expenseData)
        });

        if (!res.ok) throw new Error("Failed");

        alert(editId ? "Expense Updated!" : "Expense Saved!");

        editId = null;

        document.getElementById("expName").value = "";
        document.getElementById("expAmount").value = "";
        document.getElementById("expCategory").value = "";
        document.getElementById("expDate").value = "";

        loadExpenses();
        showSection('list');

    } catch (error) {
        console.error(error);
        alert("Error saving expense!");
    }
}

/* ================= EDIT ================= */

function editExpense(id) {

    const expense = expenses.find(e => (e._id || e.id) === id);
    if (!expense) return;

    document.getElementById("expName").value = expense.name;
    document.getElementById("expAmount").value = expense.amount;
    document.getElementById("expCategory").value = expense.category;
    document.getElementById("expDate").value = expense.date;

    editId = id;
    showSection('add');
}

/* ================= DELETE ================= */

async function deleteExpense(id) {
    await fetch(`${API}/expense/${id}`, { method: "DELETE" });
    loadExpenses();
}

/* ================= TABLE ================= */

function renderTable() {

    const table = document.getElementById("expenseTable");
    table.innerHTML = "";

    if (!expenses || expenses.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="5">No expenses found.</td>
            </tr>
        `;
        return;
    }

    expenses.forEach(e => {
        const id = e._id || e.id;

        table.innerHTML += `
        <tr>
            <td>${e.name}</td>
            <td>‚Çπ${e.amount}</td>
            <td>${e.category}</td>
            <td>${e.date}</td>
            <td>
                <button onclick="editExpense('${id}')">Edit</button>
                <button onclick="deleteExpense('${id}')">Delete</button>
            </td>
        </tr>`;
    });
}

/* ================= SUMMARY ================= */

function updateSummary() {
    const total = expenses.reduce((s,e)=>s+e.amount,0);
    document.getElementById("totalIncome").textContent = income;
    document.getElementById("totalSavings").textContent = savings;
    document.getElementById("totalExpense").textContent = total;

    const remaining = income - savings - total;

    document.getElementById("remainingBalance").textContent =
        remaining >= 0 ? remaining : 0;
}


async function loadAIAdvice() {

    try {

        const res = await fetch(`${API}/ai-advice/${email}?income=${income}`);
        const advice = await res.text();

        document.getElementById("aiAdvice").innerText = advice;

        const match = advice.match(/AI Budget Score:\s*(\d+)/);

        if (match) {
            const score = parseInt(match[1]);
            const bar = document.getElementById("scoreBar");

            bar.style.width = score + "%";
            bar.innerText = score + "/100";

            if (score > 75) bar.style.background = "green";
            else if (score > 50) bar.style.background = "orange";
            else bar.style.background = "red";
        }

    } catch (error) {
        console.error("AI Error:", error);
        document.getElementById("aiAdvice").innerText =
            "AI insights unavailable. Check backend.";
    }
}

/* ================= HELPERS ================= */
function showSection(id){
    ['incomeBox','savingsBox','add','list','monthly','yearly']
    .forEach(sec=>document.getElementById(sec).style.display="none");

    document.getElementById(id).style.display="block";

    // üî• Load AI when All Expenses page opens
    if(id === "list"){
        loadAIAdvice();
    }
}


function toggleTheme(){
    document.body.classList.toggle('dark');
}

function logout(){
    localStorage.clear();
    window.location.href="login.html";
}

</script>



</body>
</html>
