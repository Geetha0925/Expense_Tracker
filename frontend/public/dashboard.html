<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BudgetWise AI ‚Äì Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI", Arial, sans-serif;}
:root{--card-bg:#ffffff;--text:#1f2933;--header:#2c3e50;--sidebar:#34495e;--primary:#00c6ff;--shadow:0 15px 35px rgba(0,0,0,0.18);}
body.dark{--card-bg:#13293d;--text:#eaf1f8;--header:#0f2a44;--sidebar:#0d2438;}
body{min-height:100vh;color:var(--text);background-image:url("https://images.unsplash.com/photo-1554224155-8d04cb21cd6c");background-size:cover;background-position:center;background-attachment:fixed;}

header{background:var(--header);color:white;padding:18px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow);}

.header-actions{display:flex;gap:10px;}
.header-actions button{padding:8px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600;}

.logout-btn{background:#e74c3c;color:white;}
.theme-btn{background:#00c6ff;color:black;}

.container{display:flex;min-height:calc(100vh - 130px);}

.sidebar{width:260px;background:var(--sidebar);padding:25px 15px;}
.sidebar button{width:100%;padding:13px;margin-bottom:14px;border:none;border-radius:12px;background:rgba(255,255,255,0.12);color:white;cursor:pointer;}
.sidebar button:hover{background:var(--primary);color:black;}

.main{flex:1;padding:35px;}

.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px;}

.summary-box{background:var(--card-bg);padding:22px;border-radius:16px;box-shadow:var(--shadow);text-align:center;}
.summary-box h4{margin-bottom:10px;font-size:15px;opacity:0.8;}
.summary-box p{font-size:24px;font-weight:bold;}

.box{background:var(--card-bg);border-radius:18px;padding:28px;box-shadow:var(--shadow);margin-bottom:30px;}

input,select{width:100%;padding:11px;margin-bottom:14px;border-radius:10px;border:1px solid #ccc;}

button{padding:11px 20px;border:none;border-radius:10px;background:linear-gradient(135deg,#00c6ff,#0072ff);color:white;cursor:pointer;}

table{width:100%;border-collapse:collapse;}
th{background:var(--header);color:white;padding:14px;}
td{padding:12px;text-align:center;border-bottom:1px solid #ddd;}

.action-btn{padding:6px 14px;border-radius:8px;color:white;border:none;}
.edit{background:#f39c12;}
.delete{background:#e74c3c;}

footer{background:var(--header);color:white;text-align:center;padding:18px;}

#incomeBox,#savingsBox,#add,#list,#monthly,#yearly{display:none;}
</style>
</head>

<body>

<header>
<h2>BudgetWise AI ‚Äì Dashboard</h2>
<div class="header-actions">
<button class="theme-btn" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<div class="sidebar">
<button onclick="showSection('incomeBox')">üí∞ Add Income</button>
<button onclick="showSection('savingsBox')">üè¶ Add Savings</button>
<button onclick="showSection('add')">‚ûï Add Expense</button>
<button onclick="showSection('list')">üìã All Expenses</button>
<button onclick="showSection('monthly')">üìä Monthly View</button>
<button onclick="showSection('yearly')">üìà Yearly View</button>
</div>

<div class="main">

<div class="summary">
<div class="summary-box"><h4>Total Income</h4><p>‚Çπ <span id="totalIncome">0</span></p></div>
<div class="summary-box"><h4>Total Expenses</h4><p>‚Çπ <span id="totalExpense">0</span></p></div>
<div class="summary-box"><h4>Total Savings</h4><p>‚Çπ <span id="totalSavings">0</span></p></div>
<div class="summary-box"><h4>Remaining Balance</h4><p>‚Çπ <span id="remainingBalance">0</span></p></div>
</div>

<div id="incomeBox" class="box">
<input id="incomeInput" type="number" placeholder="Enter Income Amount">
<button onclick="setIncome()">Save Income</button>
</div>

<div id="savingsBox" class="box">
<input id="savingsInput" type="number" placeholder="Enter Savings Amount">
<button onclick="setSavings()">Save Savings</button>
</div>

<div id="add" class="box">
<input id="expName" placeholder="Expense Name">
<input id="expAmount" type="number" placeholder="Amount">
<select id="expCategory">
<option value="">Select Category</option>
<option>Food</option><option>Rent</option><option>Travel</option><option>Shopping</option><option>Other</option>
</select>
<input id="expDate" type="date">
<button onclick="addExpense()">Save Expense</button>
</div>

<div id="list" class="box">
<table>
<thead>
<tr><th>Name</th><th>Amount</th><th>Category</th><th>Date</th><th>Action</th></tr>
</thead>
<tbody id="expenseTable"></tbody>
</table>
</div>

<div id="monthly" class="box">
<input type="month" id="monthSelect" onchange="renderMonthlyChart()">
<canvas id="monthlyChart"></canvas>
</div>

<div id="yearly" class="box">
<input type="number" id="yearSelect" placeholder="Enter Year (2026)" onchange="renderYearlyChart()">
<canvas id="yearlyChart"></canvas>
</div>

</div>
</div>

<footer>¬© 2026 BudgetWise AI ‚Äì MongoDB Dashboard</footer>

<script>
const API = "http://localhost:8080/auth";
const email = localStorage.getItem('bw_user_email');

if (localStorage.getItem('bw_logged_in') !== "true" || !email) {
    alert("Please login first!");
    window.location.href = "login.html";
}

let expenses = [];
let income = Number(localStorage.getItem("bw_income")) || 0;
let savings = Number(localStorage.getItem("bw_savings")) || 0;
let editId = null;

const today = new Date().toISOString().split('T')[0];

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('expDate').max = today;
    loadExpenses();
    showSection('list');
});

// LOAD DATA
async function loadExpenses() {
    try {
        const res = await fetch(`${API}/expenses/${email}`);
        expenses = await res.json() || [];
        renderTable();
        updateSummary();
        renderMonthlyChart();
        renderYearlyChart();
    } catch {
        alert("Backend not running!");
        expenses = [];
    }
}

// ADD / UPDATE EXPENSE
async function addExpense() {
    const name = expName.value.trim();
    const amount = Number(expAmount.value);
    const category = expCategory.value;
    const date = expDate.value;

    if (!name || !amount || !category || !date) return alert("Fill all fields!");
    if (date > today) return alert("Future date not allowed!");

    const totalExpense = expenses.reduce((sum,e)=>sum+e.amount,0);
    const balance = income - savings - totalExpense;

    if ((balance - amount) < 1000) return alert("Minimum ‚Çπ1000 balance required!");

    const expense = { userEmail: email, name, amount, category, date };

    try {
        const url = editId ? `${API}/expense/${editId}` : `${API}/expense`;
        const method = editId ? "PUT" : "POST";

        await fetch(url, {
            method,
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(expense)
        });

        editId = null;
        clearForm();
        loadExpenses();
        alert("‚úÖ Expense saved!");
    } catch {
        alert("Save failed!");
    }
}

// DELETE
async function deleteExpense(id) {
    if (!confirm("Delete this expense?")) return;
    await fetch(`${API}/expense/${id}`, { method:"DELETE" });
    loadExpenses();
}

// EDIT
function editExpense(id) {
    const e = expenses.find(x => x._id === id);
    if (!e) return;

    expName.value = e.name;
    expAmount.value = e.amount;
    expCategory.value = e.category;
    expDate.value = e.date;

    editId = id;
    showSection('add');
}

// TABLE RENDER
function renderTable() {
    expenseTable.innerHTML = "";
    expenses.forEach(e => {
        expenseTable.innerHTML += `
        <tr>
            <td>${e.name}</td>
            <td>‚Çπ${e.amount}</td>
            <td>${e.category}</td>
            <td>${e.date}</td>
            <td>
                <button class="action-btn edit" onclick="editExpense('${e._id}')">Edit</button>
                <button class="action-btn delete" onclick="deleteExpense('${e._id}')">Delete</button>
            </td>
        </tr>`;
    });
}

// SUMMARY
function updateSummary() {
    const total = expenses.reduce((sum,e)=>sum+e.amount,0);
    totalIncome.textContent = income;
    totalSavings.textContent = savings;
    totalExpense.textContent = total;
    remainingBalance.textContent = income - savings - total;
}

// CHARTS
let monthlyChart, yearlyChart;

function renderMonthlyChart() {
    const totals = {};
    expenses.forEach(e => {
        const month = e.date.substring(0,7);
        totals[month] = (totals[month] || 0) + e.amount;
    });

    const labels = Object.keys(totals);
    const data = Object.values(totals);

    if (monthlyChart) monthlyChart.destroy();

    monthlyChart = new Chart(document.getElementById("monthlyChart"), {
        type: 'bar',
        data: { labels, datasets:[{ label:'Monthly Expenses', data }] },
        options: { responsive:true }
    });
}

function renderYearlyChart() {
    const totals = {};
    expenses.forEach(e => {
        const year = e.date.substring(0,4);
        totals[year] = (totals[year] || 0) + e.amount;
    });

    const labels = Object.keys(totals);
    const data = Object.values(totals);

    if (yearlyChart) yearlyChart.destroy();

    yearlyChart = new Chart(document.getElementById("yearlyChart"), {
        type: 'line',
        data: { labels, datasets:[{ label:'Yearly Expenses', data }] },
        options: { responsive:true }
    });
}

// INCOME
function setIncome() {
    income = Number(incomeInput.value) || 0;
    localStorage.setItem("bw_income", income);
    incomeInput.value = "";
    updateSummary();
}

// SAVINGS
function setSavings() {
    savings = Number(savingsInput.value) || 0;
    localStorage.setItem("bw_savings", savings);
    savingsInput.value = "";
    updateSummary();
}

// HELPERS
function clearForm() {
    expName.value = "";
    expAmount.value = "";
    expCategory.value = "";
    expDate.value = "";
}

function showSection(id) {
    ['incomeBox','savingsBox','add','list','monthly','yearly'].forEach(sec=>{
        document.getElementById(sec).style.display="none";
    });
    document.getElementById(id).style.display="block";
}

function toggleTheme() {
    document.body.classList.toggle('dark');
}

function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}
</script>

</body>
</html>
